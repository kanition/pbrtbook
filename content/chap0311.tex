\section{习题}\label{sec:习题03}

\begin{enumerate}
    \item \circletwo 像三角网格和细分曲面那样基于网格的形状的
          一个良好性质是形状的顶点可以变换到世界空间，
          这样在执行光线相交测试之前就不需要将射线变换到物体空间中。
          有趣的是，光线-二次曲面相交也可以做同样的事。
          本章二次曲面的隐式形式都形如
          \begin{align*}
              Ax^2+Bxy+Cxz+Dy^2+Eyz+Fz^2+G=0\, ,
          \end{align*}
          其中一些常数$A\ldots G$为零。更一般地，
          我们可以用方程
          \begin{align*}
              Ax^2+By^2+Cz^2+2Dxy+2Eyz+2Fxz+2Gx+2Hy+2Iz+J=0
          \end{align*}
          定义二次曲面，其中参数$A\ldots J$的大多数并不与之前的$A\ldots G$直接相关。
          该形式中，二次曲面可以表示为$4\times4$的对称矩阵$\bm Q$：
          \begin{align*}
              [x\ y\ z\ 1]\left[
                  \begin{array}{cccc}
                      A & D & F & G \\
                      D & B & E & H \\
                      F & E & C & I \\
                      G & H & I & J
                  \end{array}
                  \right]\left[\begin{array}{c}
                      x \\y\\z\\1
                  \end{array}\right]=\bm p^{\mathrm{T}}\bm Q\bm p=0\, .
          \end{align*}
          有了该表示，首先证明表示被矩阵$\bm M$变换的二次曲面的矩阵$\bm Q'$为
          \begin{align*}
              \bm Q'=(\bm M^{\mathrm{T}})^{-1}\bm Q\bm M^{-1}\, .
          \end{align*}
          这样可以证明对于任意满足$\bm p^{\mathrm{T}}\bm Q\bm p=0$的点$\bm p$，
          如果我们对$\bm p$施加变换$\bm M$并算得$\bm p'=\bm M\bm p$，
          则我们会发现$\bm Q'$满足$(\bm p')^{\mathrm{T}}\bm Q'\bm p'=0$.
          接着，将射线方程代入之前更一般的二次曲面方程计算二次方程$at^2+bt+c=0$
          用传入函数\refvar{Quadratic}{()}的矩阵$\bm Q$的元素形式表示的系数。
          现在在pbrt中实现该方法并用它替代原来的二次曲面相交例程。
          注意如果$\theta_{\max}$等等不是$2\pi$，
          则你仍需要将得到的世界空间命中点变换到物体空间以测试它们。
          性能与原始方案相比如何？
    \item \circleone 为二次曲面改进物体空间边界框例程
          以适当考虑$\displaystyle\varphi_{\max}<\frac{3\pi}{2}$，
          并在可能时计算更紧的边界框。
          当渲染部分二次曲面形状场景时性能提升了多少？
    \item \circletwo 还有以许多方式优化pbrt中各种二次曲面图元实现的空间。
          例如，对于完整球体而言相交例程中一些与部分球体相关的测试是不必要的。
          此外，一些二次曲面调用的三角函数其实可以
          用观察特定图元几何结构的方式变为更简单的表达式。
          研究加速这些方法的方式。
          当渲染二次曲面场景时这样做对pbrt总运行时间有多少改进？
    \item \circleone 目前pbrt在三角形需要时每次都重新计算
          偏导数$\displaystyle\frac{\partial \bm p}{\partial u}$
          和$\displaystyle\frac{\partial \bm p}{\partial v}$，
          即使它们对每个三角形都是常数。
          预先计算这些向量并分析速度/存储取舍，尤其是对于大型三角网格。
          场景的深度复杂度和图像中的三角形大小如何影响这种取舍？
    \item \circletwo 在pbrt中将支持任意顶点数量和凸或\keyindex{凹}{concave}{}多边形
          的通用\keyindex{多边形}{polygon}{}图元实现为新的\refvar{Shape}{}。
          你可以假设已经提供了有效多边形且多边形的所有顶点都在同一平面上，
          但你可能想在不是这种情况时发出警告。
          计算光线-多边形相交的一个高效技术是由多边形的法线和该多边形所在平面上的一点求得该平面方程。
          然后计算射线与该平面的相交并将交点和多边形顶点投影到2D。
          再运用2D点在多边形内的测试确定该点是否在多边形内。
          这样做的一个简单方式是高效进行2D光线追踪计算，
          将射线与每条边线段相交，并计数它穿过了多少次。
          如果它穿过了奇数次，则该点在多边形内且存在相交。
          该思路的图示见\reffig{3.47}。
          你可能发现阅读\citet{HAINES199424}调研了许多高效的点在多边形内测试方法的论文会很有帮助。
          里面描述的一些技术可能有益于优化该测试。
          此外，\citet{10.5555/2821579}的13.3.3节
          讨论了适用所有极端情况的策略：例如当2D射线精确对齐一边或穿过多边形顶点时。
          \begin{figure}[htbp]
              \centering\input{Pictures/chap03/Polygonintersectproject.tex}
              \caption{光线-多边形相交测试可通过求射线与多边形平面交点、
                  将命中点和多边形顶点投影到轴对齐平面以及做2D点在多边形内测试来完成。}
              \label{fig:3.47}
          \end{figure}
    \item \circletwo \keyindex{体素构造表示}{constructive solid geometry}{}(CSG)是
          经典的实体建模技术，通过考虑诸多图元形状的并、交、差构建复杂形状。
          例如，如果一个形状建模为圆柱体和一组与之部分重合的球体的差，
          则球体可用于创建圆柱体上的凹坑。
          详见\citet{10.5555/74803}了解更多关于CSG的信息。
          向pbrt添加CSG支持并渲染展示可以用CSG渲染的有趣图像。
          你可能想阅读首次描述了光线追踪可以怎样用于渲染CSG描述的模型的\citet{ROTH1982109}，
          以及讨论CSG光线追踪精度相关问题的\citet{10.5555/93267.93276}。
    \item \circletwo 程序化描述参数曲面：编写一个接收形如$f(u,v)\rightarrow(x,y,z)$的通用数学表达式
          将参数曲面描述为$(u,v)$函数的\refvar{Shape}{}。
          在网格位置$(u,v)$处求给定函数的值，并创建近似该给定曲面的三角网格。
    \item \circletwo 自适应曲线细化：基于形状\refvar{Curve}{}所占屏幕区域
          调整与之相交所用的递归细化层级数。
          一个方法是利用类\refvar{RayDifferential}{}，
          它表示了给定射线所表达的图像空间区域
          （然而目前只有\refvar{Ray}{}而不是\refvar{RayDifferential}{}传入
          方法\refvar{Shape::Intersect}{()}，
          所以你需要修改系统的其他部分使得射线差分可用）。
          或者，你可以修改\refvar{Camera}{}以提供关于世界空间里的点之间
          在图像平面上的向量投影长度的信息，并让相机在\refvar{Curve}{}创建期间可用。
    \item \circlethree 几乎所有细分曲面方法都基于三角网格或\keyindex{四边形}{quadrilateral}{}网格细化。
          如果渲染系统只支持一种网格，则其他类型的网格一般在预处理步骤被细化以创建期望类型的面。
          然而，这样做会在最终细分曲面中引入痕迹\sidenote{译者注：原文artifact。}。
          阅读\citet{10.1111/1467-8659.t01-2-00647}关于
          同时支持四边形和三角形面网格的混合细分方案的论文，并实现它们的方法。
          说明你实现的细分曲面创建的案例不会有出现于pbrt当前细分实现输出的那种痕迹。
    \item \circletwo 细分曲面的光滑度并不总是如意的。
          有时能将细分控制网格的一些边标注为“褶皱”\sidenote{译者注：原文crease。}并
          运用不同细分规则以保留锐利边是很有用的。
          扩展本章的细分曲面实现使得一些边可以标为褶皱，
          并用边缘细分规则计算沿这些边的顶点位置。
          渲染能说明由此引发的区别的图像。
    \item \circlethree 自适应细分：\refsec{细分曲面}细分曲面实现的一个缺点是
          每个面总是被细化固定次数：这可能意味着一些面的细化不够，
          导致三角网格上有可见的小平面，一些面过度细化，导致过多内存使用量和渲染时间。
          通过自适应细分，单个面一旦达到特定误差阈值就不再细分。
          一个容易实现的误差阈值计算每个面及其直接相邻面的法线。
          如果它们互相充分接近（例如，用点积来测试），
          则那个面的极限曲面会适度平坦且后续细化可能对最终曲面没什么影响。
          或者，你可能想对细分面在图像平面上覆盖的区域作近似并
          继续细分直到该区域变得充分小。该近似可用射线差分做到；
          详见\refsub{寻找纹理采样率}解释怎样将射线差分与屏幕空间量联系\sidenote{译者注：原文screen space footprint。}。
          本习题最棘手的部分是一些不需要细分的面由于平坦测试仍需要细分
          来提供顶点好让确实需要细分的相邻面能获得它们顶点的一环。
          特别地，相邻面相差不超过一级细分。
          你可能发现阅读最近\citet{10.1145/1572769.1572785}
          和\citet{10.1145/1661412.1618496}讨论怎么避免
          在自适应细分网格中崩溃的论文很有用。
    \item \circlethree 光线追踪点采样\sidenote{译者注：原文point-sampled。}几何：
          扩展方法以渲染表示为一批点样本的复杂模型\citep{10.1111/1467-8659.t01-2-00647,10.1145/344779.344936,10.1145/344779.344940}，
          \citet{10.1007/978-3-7091-6303-0_29}描述了
          在空间中射线与一批定向点样本相交的方法。
          当射线接近充足的点样本局部密度时它们概率地决定相交的发生并
          用附近样本的加权平均计算曲面法线。
          阅读他们的论文并扩展pbrt以支持点采样几何形状。
          有任何pbrt的基本接口需要扩展或推广以支持像这样的形状吗？
    \item \circlethree 形变运动模糊：第\refchap{图元和相交加速}的
          \refsub{TransformedPrimitive：物体实例化与动画基元}中\refvar{TransformedPrimitive}{}通过
          随时间变化的图元变换来支持动画形状。
          然而，这种动画不够通用以表示每个顶点在开始时刻
          有一个给定位置在结束时刻有另一个给定位置的三角网格
          （例如，这种动画描述可用于描述奔跑的角色模型，
          其身体的不同部分以不同方式运动）。
          实现支持指定开始和结束坐标系中顶点位置的更一般\refvar{Triangle}{}形状
          并基于传入相交方法的射线时间在它们之间插值。确保适当更新边界例程。
          有大量动作的三角网格可能因为扫过巨大边界框的三角形而表现出很差的性能
          并因此执行许多并不命中三角形的光线-三角形相交。
          你能想出用于降低该问题影响的方法吗？
    \item \circlethree 隐函数：正如二次曲面形状的隐式定义
          对于推导光线相交算法是一个有用的起点，
          更复杂的隐函数也可以用于定义有趣的形状。
          特别地，难以建模的有机形状、水滴等可以很好地用隐式曲面表示。
          \citet{10.1145/357306.357310}介绍了直接渲染隐式曲面的思想，
          \citet{Wyvill1989}给出了隐式曲面的基函数
          且与\citeauthor{10.1145/357306.357310}相比有许多优点。
          实现一个求取射线与通用隐式曲面相交处的方法并将其添入pbrt。
          你可能希望阅读\citet{10.1145/74333.74364}
          以及\citet{Hart1996}的论文了解相应光线追踪的方法。
          \citet{10.5555/93267.93276}针对射线与隐式曲面稳定相交
          使用区间运算的算法给出了另一个求取这些相交处的高效方法,
          最近\citet{10.1111/j.1467-8659.2008.01189.x}描述了对该思想的改进。
          你可能沿这些路线发现一个比其他更容易实现的方法。
          需要时可参考\citet{moore1966interval}关于区间运算的书籍。
    \item \circlethree L系统：\citet{10.1145/800031.808571}向图形学
          引入了一项非常成功的程序化建模植物技术，
          他用\keyindex{L系统}{Lindenmayer system}{}(L-system)建模分岔植物结构。
          \citeauthor{Prusinkiewicz:1986:10.20380/GI1986.44}及其合作者
          已将该方法推广到涵盖大量植物类型和决定其外观的因素
          \citep{Prusinkiewicz:1986:10.20380/GI1986.44,10.1145/192161.192254,
              10.1145/280814.280898,10.1145/383259.383291}。
          L系统通过语法描述这类形状的分岔结构。
          该语法可求值构建描述植物拓扑表示的表达式，然后可翻译为几何表示。
          向pbrt添加以该语法为输入的L系统图元并对其求值以创建它描述的形状。
    \item \circleone 给定任意点$(x,y,z)$，\refeq{3.16}给出的
          施加缩放变换$(2,1,4)$的误差边界是什么？实际引入的误差是多少？
    \item \circletwo 二次曲面形状都在其相交测试中用类\refvar{EFloat}{}来
          定界算得$t$值中的误差，这样射线端点之后的相交不会错误地报告为实际相交。
          首先，在渲染含有一个或多个二次曲面的场景时度量对其使用常规\refvar{Float}{}的性能差别。
          接着像\refsub{避免射线端点之后的相交}中三角形做的那样为这些形状算得的$t$值手动推导保守误差边界。
          实现你的方法。你可能发现用类\refvar{EFloat}{}经验地测试你推导的正确性很有用。
          度量你的实现的性能差别。
    \item \circletwo 一个细节妨碍了形状\refvar{Triangle}{}当前实现的水密性：
          三角形顶点的平移和错切引入了舍入误差，这在三角形边界框的范围内是必须考虑的；
          详见\citet{Woop2013Watertight}3.3节的讨论（和方案）。
          修改pbrt以合并针对该缺点的方案。
          你能找出因为你的修正而消除了微小图像错误的场景吗？
    \item \circlethree 在相机空间渲染：因为浮点运算在端点附近比远离端点处提供了更多精度，
          将场景变换到相机位于原点的坐标系能降低浮点精度不足造成的误差影响
          （例如，考虑渲染相机位于世界空间中$(100000,100000,100000)$、看向相距两单位的单位球的场景
          与相机位于原点、也看向两单位远的球体场景的差别：后一种情况有更多精度位数可用来表示交点）。
          修改pbrt使得主要在相机空间内执行渲染计算，而不是像当前在世界空间内。
          你将需要修改\refvar{Camera}{}实现来返回相机空间射线
          并修改形状来把入射光线从相机空间变换到物体空间。
          你将需要全程把\refvar{TriangleMesh}{}的顶点变换到相机空间。
          度量你的实现与未修改的pbrt版本相比的性能并用两个系统渲染各种场景
          （特别地，确保测试一些相机远离世界空间原点的场景）。
          你看到的图像差别有多大？
\end{enumerate}